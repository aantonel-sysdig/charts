# requires unittest plugin: https://github.com/quintush/helm-unittest
# Run "helm unittest -3 -f ./tests/runtimescanner_test.yaml ." from within the `charts/node-analyzer` folder
suite: Test RuntimeScanner configuration
templates:
  - ../templates/daemonset-node-analyzer.yaml
values:
  - ../values.yaml

tests:
  - it: "Add extra volume through nodeAnalyzer.imageAnalyzer.extraVolumes parameter (deprecated)"
    templates:
      - ../templates/daemonset-node-analyzer.yaml
    set:
      nodeAnalyzer:
        imageAnalyzer:
          extraVolumes:
            volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock
    asserts:
      - isKind:
          of: DaemonSet
      - contains:
          path: "spec.template.spec.volumes"
          content:
            name: docker-sock
            hostPath:
              path: /var/run/docker.sock

  - it: "Add extra volume through nodeAnalyzer.extraVolumes parameter"
    templates:
      - ../templates/daemonset-node-analyzer.yaml
    set:
      nodeAnalyzer:
          extraVolumes:
            volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock
    asserts:
      - isKind:
          of: DaemonSet
      - contains:
          path: "spec.template.spec.volumes"
          content:
            name: docker-sock
            hostPath:
              path: /var/run/docker.sock

  - it: "is disabled if explicit flag is set, should override newEngineOnly"
    set:
      secure:
        vulnerabilityManagement:
          newEngineOnly: true
      nodeAnalyzer:
        runtimeScanner:
          deploy: false
    templates:
      - ../templates/daemonset-node-analyzer.yaml
    asserts:
      - isKind:
          of: DaemonSet
      - isNotNull:
          path: "spec.template.spec.containers[?(@.name == 'sysdig-host-scanner')]"
      - lengthEqual:
          path: spec.template.spec.containers
          count: 1

  - it: "is disabled by default, legacy will be deployed"
    templates:
      - ../templates/daemonset-node-analyzer.yaml
    asserts:
      - isKind:
          of: DaemonSet
      - isNotNull:
          path: "spec.template.spec.containers[?(@.name == 'sysdig-image-analyzer')]"
      - isNotNull:
          path: "spec.template.spec.containers[?(@.name == 'sysdig-host-analyzer')]"
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2

  - it: "is enabled when newEngineOnly is set"
    set:
      secure:
        vulnerabilityManagement:
          newEngineOnly: true
    templates:
      - ../templates/daemonset-node-analyzer.yaml
    asserts:
      - isKind:
          of: DaemonSet
      - isNotNull:
          path: "spec.template.spec.containers[?(@.name == 'sysdig-runtime-scanner')]"
      - isNotNull:
          path: "spec.template.spec.containers[?(@.name == 'sysdig-host-scanner')]"
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
